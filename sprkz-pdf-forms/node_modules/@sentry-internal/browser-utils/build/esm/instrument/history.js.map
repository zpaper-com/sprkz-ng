{"version":3,"file":"history.js","sources":["../../../src/instrument/history.ts"],"sourcesContent":["import type { HandlerDataHistory } from '@sentry/core';\nimport { addHandler, fill, maybeInstrument, supportsHistory, triggerHandlers } from '@sentry/core';\nimport { WINDOW } from '../types';\n\nlet lastHref: string | undefined;\n\n/**\n * Add an instrumentation handler for when a fetch request happens.\n * The handler function is called once when the request starts and once when it ends,\n * which can be identified by checking if it has an `endTimestamp`.\n *\n * Use at your own risk, this might break without changelog notice, only used internally.\n * @hidden\n */\nexport function addHistoryInstrumentationHandler(handler: (data: HandlerDataHistory) => void): void {\n  const type = 'history';\n  addHandler(type, handler);\n  maybeInstrument(type, instrumentHistory);\n}\n\n/**\n * Exported just for testing\n */\nexport function instrumentHistory(): void {\n  // The `popstate` event may also be triggered on `pushState`, but it may not always reliably be emitted by the browser\n  // Which is why we also monkey-patch methods below, in addition to this\n  WINDOW.addEventListener('popstate', () => {\n    const to = WINDOW.location.href;\n    // keep track of the current URL state, as we always receive only the updated state\n    const from = lastHref;\n    lastHref = to;\n\n    if (from === to) {\n      return;\n    }\n\n    const handlerData = { from, to } satisfies HandlerDataHistory;\n    triggerHandlers('history', handlerData);\n  });\n\n  // Just guard against this not being available, in weird environments\n  if (!supportsHistory()) {\n    return;\n  }\n\n  function historyReplacementFunction(originalHistoryFunction: () => void): () => void {\n    return function (this: History, ...args: unknown[]): void {\n      const url = args.length > 2 ? args[2] : undefined;\n      if (url) {\n        const from = lastHref;\n\n        // Ensure the URL is absolute\n        // this can be either a path, then it is relative to the current origin\n        // or a full URL of the current origin - other origins are not allowed\n        // See: https://developer.mozilla.org/en-US/docs/Web/API/History/pushState#url\n        // coerce to string (this is what pushState does)\n        const to = getAbsoluteUrl(String(url));\n\n        // keep track of the current URL state, as we always receive only the updated state\n        lastHref = to;\n\n        if (from === to) {\n          return originalHistoryFunction.apply(this, args);\n        }\n\n        const handlerData = { from, to } satisfies HandlerDataHistory;\n        triggerHandlers('history', handlerData);\n      }\n      return originalHistoryFunction.apply(this, args);\n    };\n  }\n\n  fill(WINDOW.history, 'pushState', historyReplacementFunction);\n  fill(WINDOW.history, 'replaceState', historyReplacementFunction);\n}\n\nfunction getAbsoluteUrl(urlOrPath: string): string {\n  try {\n    const url = new URL(urlOrPath, WINDOW.location.origin);\n    return url.toString();\n  } catch {\n    // fallback, just do nothing\n    return urlOrPath;\n  }\n}\n"],"names":[],"mappings":";;;AAIA,IAAI,QAAQ;;AAEZ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,SAAS,gCAAgC,CAAC,OAAO,EAA4C;AACpG,EAAE,MAAM,IAAA,GAAO,SAAS;AACxB,EAAE,UAAU,CAAC,IAAI,EAAE,OAAO,CAAC;AAC3B,EAAE,eAAe,CAAC,IAAI,EAAE,iBAAiB,CAAC;AAC1C;;AAEA;AACA;AACA;AACO,SAAS,iBAAiB,GAAS;AAC1C;AACA;AACA,EAAE,MAAM,CAAC,gBAAgB,CAAC,UAAU,EAAE,MAAM;AAC5C,IAAI,MAAM,EAAA,GAAK,MAAM,CAAC,QAAQ,CAAC,IAAI;AACnC;AACA,IAAI,MAAM,IAAA,GAAO,QAAQ;AACzB,IAAI,QAAA,GAAW,EAAE;;AAEjB,IAAI,IAAI,IAAA,KAAS,EAAE,EAAE;AACrB,MAAM;AACN;;AAEA,IAAI,MAAM,WAAA,GAAc,EAAE,IAAI,EAAE,IAAG;AACnC,IAAI,eAAe,CAAC,SAAS,EAAE,WAAW,CAAC;AAC3C,GAAG,CAAC;;AAEJ;AACA,EAAE,IAAI,CAAC,eAAe,EAAE,EAAE;AAC1B,IAAI;AACJ;;AAEA,EAAE,SAAS,0BAA0B,CAAC,uBAAuB,EAA0B;AACvF,IAAI,OAAO,WAAyB,GAAG,IAAI,EAAmB;AAC9D,MAAM,MAAM,GAAA,GAAM,IAAI,CAAC,MAAA,GAAS,CAAA,GAAI,IAAI,CAAC,CAAC,CAAA,GAAI,SAAS;AACvD,MAAM,IAAI,GAAG,EAAE;AACf,QAAQ,MAAM,IAAA,GAAO,QAAQ;;AAE7B;AACA;AACA;AACA;AACA;AACA,QAAQ,MAAM,KAAK,cAAc,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC;;AAE9C;AACA,QAAQ,QAAA,GAAW,EAAE;;AAErB,QAAQ,IAAI,IAAA,KAAS,EAAE,EAAE;AACzB,UAAU,OAAO,uBAAuB,CAAC,KAAK,CAAC,IAAI,EAAE,IAAI,CAAC;AAC1D;;AAEA,QAAQ,MAAM,WAAA,GAAc,EAAE,IAAI,EAAE,IAAG;AACvC,QAAQ,eAAe,CAAC,SAAS,EAAE,WAAW,CAAC;AAC/C;AACA,MAAM,OAAO,uBAAuB,CAAC,KAAK,CAAC,IAAI,EAAE,IAAI,CAAC;AACtD,KAAK;AACL;;AAEA,EAAE,IAAI,CAAC,MAAM,CAAC,OAAO,EAAE,WAAW,EAAE,0BAA0B,CAAC;AAC/D,EAAE,IAAI,CAAC,MAAM,CAAC,OAAO,EAAE,cAAc,EAAE,0BAA0B,CAAC;AAClE;;AAEA,SAAS,cAAc,CAAC,SAAS,EAAkB;AACnD,EAAE,IAAI;AACN,IAAI,MAAM,GAAA,GAAM,IAAI,GAAG,CAAC,SAAS,EAAE,MAAM,CAAC,QAAQ,CAAC,MAAM,CAAC;AAC1D,IAAI,OAAO,GAAG,CAAC,QAAQ,EAAE;AACzB,IAAI,MAAM;AACV;AACA,IAAI,OAAO,SAAS;AACpB;AACA;;;;"}
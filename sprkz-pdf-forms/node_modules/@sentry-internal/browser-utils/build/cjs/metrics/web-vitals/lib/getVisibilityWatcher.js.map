{"version":3,"file":"getVisibilityWatcher.js","sources":["../../../../../src/metrics/web-vitals/lib/getVisibilityWatcher.ts"],"sourcesContent":["/*\n * Copyright 2020 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { WINDOW } from '../../../types';\nimport { getActivationStart } from './getActivationStart';\n\nlet firstHiddenTime = -1;\n\nconst initHiddenTime = () => {\n  // If the document is hidden when this code runs, assume it was always\n  // hidden and the page was loaded in the background, with the one exception\n  // that visibility state is always 'hidden' during prerendering, so we have\n  // to ignore that case until prerendering finishes (see: `prerenderingchange`\n  // event logic below).\n  return WINDOW.document?.visibilityState === 'hidden' && !WINDOW.document?.prerendering ? 0 : Infinity;\n};\n\nconst onVisibilityUpdate = (event: Event) => {\n  // If the document is 'hidden' and no previous hidden timestamp has been\n  // set, update it based on the current event data.\n  if (WINDOW.document!.visibilityState === 'hidden' && firstHiddenTime > -1) {\n    // If the event is a 'visibilitychange' event, it means the page was\n    // visible prior to this change, so the event timestamp is the first\n    // hidden time.\n    // However, if the event is not a 'visibilitychange' event, then it must\n    // be a 'prerenderingchange' event, and the fact that the document is\n    // still 'hidden' from the above check means the tab was activated\n    // in a background state and so has always been hidden.\n    firstHiddenTime = event.type === 'visibilitychange' ? event.timeStamp : 0;\n\n    // Remove all listeners now that a `firstHiddenTime` value has been set.\n    removeChangeListeners();\n  }\n};\n\nconst addChangeListeners = () => {\n  addEventListener('visibilitychange', onVisibilityUpdate, true);\n  // IMPORTANT: when a page is prerendering, its `visibilityState` is\n  // 'hidden', so in order to account for cases where this module checks for\n  // visibility during prerendering, an additional check after prerendering\n  // completes is also required.\n  addEventListener('prerenderingchange', onVisibilityUpdate, true);\n};\n\nconst removeChangeListeners = () => {\n  removeEventListener('visibilitychange', onVisibilityUpdate, true);\n  removeEventListener('prerenderingchange', onVisibilityUpdate, true);\n};\n\nexport const getVisibilityWatcher = () => {\n  if (WINDOW.document && firstHiddenTime < 0) {\n    // Check if we have a previous hidden `visibility-state` performance entry.\n    const activationStart = getActivationStart();\n    const firstVisibilityStateHiddenTime = !WINDOW.document.prerendering\n      ? globalThis.performance\n          .getEntriesByType('visibility-state')\n          .filter(e => e.name === 'hidden' && e.startTime > activationStart)[0]?.startTime\n      : undefined;\n\n    // Prefer that, but if it's not available and the document is hidden when\n    // this code runs, assume it was hidden since navigation start. This isn't\n    // a perfect heuristic, but it's the best we can do until the\n    // `visibility-state` performance entry becomes available in all browsers.\n    firstHiddenTime = firstVisibilityStateHiddenTime ?? initHiddenTime();\n    // We're still going to listen to for changes so we can handle things like\n    // bfcache restores and/or prerender without having to examine individual\n    // timestamps in detail.\n    addChangeListeners();\n  }\n  return {\n    get firstHiddenTime() {\n      return firstHiddenTime;\n    },\n  };\n};\n"],"names":["WINDOW","getActivationStart"],"mappings":";;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AAKA,IAAI,eAAA,GAAkB,EAAE;;AAExB,MAAM,cAAA,GAAiB,MAAM;AAC7B;AACA;AACA;AACA;AACA;AACA,EAAE,OAAOA,YAAM,CAAC,QAAQ,EAAE,eAAA,KAAoB,QAAA,IAAY,CAACA,YAAM,CAAC,QAAQ,EAAE,eAAe,CAAA,GAAI,QAAQ;AACvG,CAAC;;AAED,MAAM,kBAAA,GAAqB,CAAC,KAAK,KAAY;AAC7C;AACA;AACA,EAAE,IAAIA,YAAM,CAAC,QAAQ,CAAE,eAAA,KAAoB,QAAA,IAAY,eAAA,GAAkB,EAAE,EAAE;AAC7E;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAI,eAAA,GAAkB,KAAK,CAAC,IAAA,KAAS,kBAAA,GAAqB,KAAK,CAAC,SAAA,GAAY,CAAC;;AAE7E;AACA,IAAI,qBAAqB,EAAE;AAC3B;AACA,CAAC;;AAED,MAAM,kBAAA,GAAqB,MAAM;AACjC,EAAE,gBAAgB,CAAC,kBAAkB,EAAE,kBAAkB,EAAE,IAAI,CAAC;AAChE;AACA;AACA;AACA;AACA,EAAE,gBAAgB,CAAC,oBAAoB,EAAE,kBAAkB,EAAE,IAAI,CAAC;AAClE,CAAC;;AAED,MAAM,qBAAA,GAAwB,MAAM;AACpC,EAAE,mBAAmB,CAAC,kBAAkB,EAAE,kBAAkB,EAAE,IAAI,CAAC;AACnE,EAAE,mBAAmB,CAAC,oBAAoB,EAAE,kBAAkB,EAAE,IAAI,CAAC;AACrE,CAAC;;AAEM,MAAM,oBAAA,GAAuB,MAAM;AAC1C,EAAE,IAAIA,YAAM,CAAC,YAAY,eAAA,GAAkB,CAAC,EAAE;AAC9C;AACA,IAAI,MAAM,eAAA,GAAkBC,qCAAkB,EAAE;AAChD,IAAI,MAAM,8BAAA,GAAiC,CAACD,YAAM,CAAC,QAAQ,CAAC;AAC5D,QAAQ,UAAU,CAAC;AACnB,WAAW,gBAAgB,CAAC,kBAAkB;AAC9C,WAAW,MAAM,CAAC,CAAA,IAAK,CAAC,CAAC,SAAS,QAAA,IAAY,CAAC,CAAC,YAAY,eAAe,CAAC,CAAC,CAAC,CAAC,EAAE;AACjF,QAAQ,SAAS;;AAEjB;AACA;AACA;AACA;AACA,IAAI,kBAAkB,8BAAA,IAAkC,cAAc,EAAE;AACxE;AACA;AACA;AACA,IAAI,kBAAkB,EAAE;AACxB;AACA,EAAE,OAAO;AACT,IAAI,IAAI,eAAe,GAAG;AAC1B,MAAM,OAAO,eAAe;AAC5B,KAAK;AACL,GAAG;AACH;;;;"}
{"version":3,"file":"reactrouterv3.js","sources":["../../src/reactrouterv3.ts"],"sourcesContent":["import {\n  browserTracingIntegration,\n  startBrowserTracingNavigationSpan,\n  startBrowserTracingPageLoadSpan,\n  WINDOW,\n} from '@sentry/browser';\nimport type { Integration, TransactionSource } from '@sentry/core';\nimport {\n  SEMANTIC_ATTRIBUTE_SENTRY_OP,\n  SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN,\n  SEMANTIC_ATTRIBUTE_SENTRY_SOURCE,\n} from '@sentry/core';\nimport type { Location } from './types';\n\n// Many of the types below had to be mocked out to prevent typescript issues\n// these types are required for correct functionality.\n\ntype HistoryV3 = {\n  location?: Location;\n  listen?(cb: (location: Location) => void): void;\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n} & Record<string, any>;\n\nexport type Route = { path?: string; childRoutes?: Route[] };\n\nexport type Match = (\n  props: { location: Location; routes: Route[] },\n  cb: (error?: Error, _redirectLocation?: Location, renderProps?: { routes?: Route[] }) => void,\n) => void;\n\ntype ReactRouterV3TransactionSource = Extract<TransactionSource, 'url' | 'route'>;\n\ninterface ReactRouterOptions {\n  history: HistoryV3;\n  routes: Route[];\n  match: Match;\n}\n\n/**\n * A browser tracing integration that uses React Router v3 to instrument navigations.\n * Expects `history` (and optionally `routes` and `matchPath`) to be passed as options.\n */\nexport function reactRouterV3BrowserTracingIntegration(\n  options: Parameters<typeof browserTracingIntegration>[0] & ReactRouterOptions,\n): Integration {\n  const integration = browserTracingIntegration({\n    ...options,\n    instrumentPageLoad: false,\n    instrumentNavigation: false,\n  });\n\n  const { history, routes, match, instrumentPageLoad = true, instrumentNavigation = true } = options;\n\n  return {\n    ...integration,\n    afterAllSetup(client) {\n      integration.afterAllSetup(client);\n\n      if (instrumentPageLoad && WINDOW.location) {\n        normalizeTransactionName(\n          routes,\n          WINDOW.location as unknown as Location,\n          match,\n          (localName: string, source: ReactRouterV3TransactionSource = 'url') => {\n            startBrowserTracingPageLoadSpan(client, {\n              name: localName,\n              attributes: {\n                [SEMANTIC_ATTRIBUTE_SENTRY_OP]: 'pageload',\n                [SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN]: 'auto.pageload.react.reactrouter_v3',\n                [SEMANTIC_ATTRIBUTE_SENTRY_SOURCE]: source,\n              },\n            });\n          },\n        );\n      }\n\n      if (instrumentNavigation && history.listen) {\n        history.listen(location => {\n          if (location.action === 'PUSH' || location.action === 'POP') {\n            normalizeTransactionName(\n              routes,\n              location,\n              match,\n              (localName: string, source: TransactionSource = 'url') => {\n                startBrowserTracingNavigationSpan(client, {\n                  name: localName,\n                  attributes: {\n                    [SEMANTIC_ATTRIBUTE_SENTRY_OP]: 'navigation',\n                    [SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN]: 'auto.navigation.react.reactrouter_v3',\n                    [SEMANTIC_ATTRIBUTE_SENTRY_SOURCE]: source,\n                  },\n                });\n              },\n            );\n          }\n        });\n      }\n    },\n  };\n}\n\n/**\n * Normalize transaction names using `Router.match`\n */\nfunction normalizeTransactionName(\n  appRoutes: Route[],\n  location: Location,\n  match: Match,\n  callback: (pathname: string, source?: ReactRouterV3TransactionSource) => void,\n): void {\n  let name = location.pathname;\n  match(\n    {\n      location,\n      routes: appRoutes,\n    },\n    (error, _redirectLocation, renderProps) => {\n      if (error || !renderProps) {\n        return callback(name);\n      }\n\n      const routePath = getRouteStringFromRoutes(renderProps.routes || []);\n      if (routePath.length === 0 || routePath === '/*') {\n        return callback(name);\n      }\n\n      name = routePath;\n      return callback(name, 'route');\n    },\n  );\n}\n\n/**\n * Generate route name from array of routes\n */\nfunction getRouteStringFromRoutes(routes: Route[]): string {\n  if (!Array.isArray(routes) || routes.length === 0) {\n    return '';\n  }\n\n  const routesWithPaths: Route[] = routes.filter((route: Route) => !!route.path);\n\n  let index = -1;\n  for (let x = routesWithPaths.length - 1; x >= 0; x--) {\n    // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n    const route = routesWithPaths[x]!;\n    if (route.path?.startsWith('/')) {\n      index = x;\n      break;\n    }\n  }\n\n  return routesWithPaths.slice(index).reduce((acc, { path }) => {\n    const pathSegment = acc === '/' || acc === '' ? path : `/${path}`;\n    return `${acc}${pathSegment}`;\n  }, '');\n}\n"],"names":[],"mappings":"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"}
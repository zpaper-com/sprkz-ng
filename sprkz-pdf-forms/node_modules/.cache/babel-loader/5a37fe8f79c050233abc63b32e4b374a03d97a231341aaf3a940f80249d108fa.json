{"ast":null,"code":"import React,{useRef,useEffect,useState,useCallback}from'react';import{Box,CircularProgress,Typography,Alert}from'@mui/material';import{PDFService}from'../../services/pdfService';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";export const PDFViewer=_ref=>{let{url,scale=1.0,currentPage=1,onDocumentLoad,onPageLoad,onError,className}=_ref;const canvasRef=useRef(null);const textLayerRef=useRef(null);const annotationLayerRef=useRef(null);const containerRef=useRef(null);const[pdfDoc,setPdfDoc]=useState(null);const[currentPageObj,setCurrentPageObj]=useState(null);const[loading,setLoading]=useState(true);const[error,setError]=useState(null);const[renderingPage,setRenderingPage]=useState(false);// Load PDF document\nuseEffect(()=>{let isMounted=true;const loadDocument=async()=>{try{setLoading(true);setError(null);console.log(`[PDF] Loading PDF from: ${url} at ${new Date().toISOString()}`);const document=await PDFService.loadDocument({url});if(!isMounted)return;setPdfDoc(document);onDocumentLoad===null||onDocumentLoad===void 0?void 0:onDocumentLoad(document);console.log(`PDF loaded successfully. Pages: ${document.numPages}`);}catch(err){if(!isMounted)return;const pdfError=err;setError(pdfError);onError===null||onError===void 0?void 0:onError(pdfError);console.error('Failed to load PDF document:',pdfError);}finally{if(isMounted){setLoading(false);}}};if(url){loadDocument();}return()=>{isMounted=false;};// eslint-disable-next-line react-hooks/exhaustive-deps\n},[url]);// Remove callback dependencies to prevent reload loops\n// Render specific page\nconst renderPage=useCallback(async pageNumber=>{if(!pdfDoc||renderingPage)return;try{setRenderingPage(true);setError(null);console.log(`[PDF] Rendering page ${pageNumber} at ${new Date().toISOString()}...`);const page=await PDFService.getPage(pdfDoc,pageNumber);setCurrentPageObj(page);onPageLoad===null||onPageLoad===void 0?void 0:onPageLoad(page);const viewport=page.getViewport({scale});// Clear previous content\nif(containerRef.current){const canvas=canvasRef.current;const textLayer=textLayerRef.current;const annotationLayer=annotationLayerRef.current;if(canvas&&textLayer&&annotationLayer){// Clear layers\nconst context=canvas.getContext('2d');if(context){context.clearRect(0,0,canvas.width,canvas.height);}textLayer.innerHTML='';annotationLayer.innerHTML='';// Set container dimensions\ncontainerRef.current.style.width=`${viewport.width}px`;containerRef.current.style.height=`${viewport.height}px`;// 1. Canvas Layer - Render visual content\nawait PDFService.renderPageToCanvas(page,canvas,scale);// 2. Text Layer - Enable text selection\ntry{const textContent=await page.getTextContent();// Set text layer dimensions and positioning\ntextLayer.style.width=`${viewport.width}px`;textLayer.style.height=`${viewport.height}px`;textLayer.className='textLayer';// Create text spans for selection (simplified implementation)\ntextContent.items.forEach((item,index)=>{if('str'in item&&item.str){const span=document.createElement('span');span.textContent=item.str;span.style.position='absolute';span.style.left=`${item.transform[4]}px`;span.style.top=`${viewport.height-item.transform[5]}px`;span.style.fontSize=`${item.height}px`;span.style.fontFamily=item.fontName||'sans-serif';span.style.color='transparent';span.style.userSelect='text';textLayer.appendChild(span);}});}catch(textError){console.warn('Failed to render text layer:',textError);}// 3. Annotation Layer - Handle interactive forms\ntry{const annotations=await page.getAnnotations({intent:'display'});if(annotations.length>0){// Set annotation layer dimensions and positioning\nannotationLayer.style.width=`${viewport.width}px`;annotationLayer.style.height=`${viewport.height}px`;annotationLayer.className='annotationLayer';// Create form elements for annotations (simplified implementation)\nannotations.forEach(annotation=>{if(annotation.subtype==='Widget'){const rect=annotation.rect;const element=document.createElement('div');element.style.position='absolute';element.style.left=`${rect[0]}px`;element.style.top=`${viewport.height-rect[3]}px`;element.style.width=`${rect[2]-rect[0]}px`;element.style.height=`${rect[3]-rect[1]}px`;element.style.backgroundColor='rgba(0, 54, 255, 0.13)';element.style.border='1px solid rgba(0, 54, 255, 0.5)';element.title=`Form field: ${annotation.fieldName||'Unknown'}`;annotationLayer.appendChild(element);}});console.log(`Rendered ${annotations.length} annotations on page ${pageNumber}`);}}catch(annotationError){console.warn('Failed to render annotation layer:',annotationError);}// Preload adjacent pages for smooth navigation\nPDFService.preloadAdjacentPages(pdfDoc,pageNumber,1);}}console.log(`Page ${pageNumber} rendered successfully`);}catch(err){const pdfError=err;setError(pdfError);onError===null||onError===void 0?void 0:onError(pdfError);console.error(`Failed to render page ${pageNumber}:`,pdfError);}finally{setRenderingPage(false);}// eslint-disable-next-line react-hooks/exhaustive-deps\n},[pdfDoc,scale,renderingPage]);// Remove callback dependencies to prevent render loops\n// Render page when currentPage or scale changes\nuseEffect(()=>{if(pdfDoc&&currentPage>=1&&currentPage<=pdfDoc.numPages){renderPage(currentPage);}// eslint-disable-next-line react-hooks/exhaustive-deps\n},[pdfDoc,currentPage,scale]);// Remove renderPage from dependencies to prevent infinite loop\n// Handle container resize for responsiveness\nuseEffect(()=>{const handleResize=()=>{if(currentPageObj&&!renderingPage){// Re-render current page with new scale if needed\nrenderPage(currentPage);}};window.addEventListener('resize',handleResize);return()=>window.removeEventListener('resize',handleResize);// eslint-disable-next-line react-hooks/exhaustive-deps\n},[currentPageObj,currentPage,renderingPage]);// Remove renderPage dependency\nif(loading){return/*#__PURE__*/_jsxs(Box,{display:\"flex\",flexDirection:\"column\",alignItems:\"center\",justifyContent:\"center\",minHeight:400,className:className,children:[/*#__PURE__*/_jsx(CircularProgress,{size:48}),/*#__PURE__*/_jsx(Typography,{variant:\"body2\",sx:{mt:2},children:\"Loading PDF document...\"})]});}if(error){return/*#__PURE__*/_jsx(Alert,{severity:\"error\",sx:{minHeight:400,display:'flex',alignItems:'center'},className:className,children:/*#__PURE__*/_jsxs(Box,{children:[/*#__PURE__*/_jsx(Typography,{variant:\"h6\",gutterBottom:true,children:\"Failed to load PDF\"}),/*#__PURE__*/_jsx(Typography,{variant:\"body2\",color:\"textSecondary\",children:error.message}),error.originalError&&/*#__PURE__*/_jsxs(Typography,{variant:\"caption\",display:\"block\",sx:{mt:1},children:[\"Technical details: \",error.originalError.message]})]})});}return/*#__PURE__*/_jsxs(Box,{className:className,sx:{position:'relative',display:'inline-block',border:'1px solid #ccc',boxShadow:'0 2px 8px rgba(0,0,0,0.1)'},children:[renderingPage&&/*#__PURE__*/_jsxs(Box,{position:\"absolute\",top:0,left:0,right:0,bottom:0,display:\"flex\",alignItems:\"center\",justifyContent:\"center\",bgcolor:\"rgba(255, 255, 255, 0.8)\",zIndex:10,children:[/*#__PURE__*/_jsx(CircularProgress,{size:32}),/*#__PURE__*/_jsxs(Typography,{variant:\"body2\",sx:{ml:2},children:[\"Rendering page \",currentPage,\"...\"]})]}),/*#__PURE__*/_jsxs(Box,{ref:containerRef,position:\"relative\",sx:{'& .textLayer':{position:'absolute',left:0,top:0,right:0,bottom:0,overflow:'hidden',opacity:0.2,lineHeight:1.0,'& > span':{color:'transparent',position:'absolute',whiteSpace:'pre',cursor:'text',transformOrigin:'0% 0%'}},'& .annotationLayer':{position:'absolute',left:0,top:0,right:0,bottom:0,'& section':{position:'absolute'},'& .linkAnnotation > a':{position:'absolute',fontSize:'1em',top:0,left:0,width:'100%',height:'100%'},'& .textWidgetAnnotation input':{background:'rgba(0, 54, 255, 0.13)',border:'1px solid transparent',boxSizing:'border-box',fontSize:'9px',height:'100%',margin:0,padding:0,verticalAlign:'top',width:'100%'},'& .textWidgetAnnotation textarea':{background:'rgba(0, 54, 255, 0.13)',border:'1px solid transparent',boxSizing:'border-box',fontSize:'9px',height:'100%',margin:0,padding:0,verticalAlign:'top',width:'100%',resize:'none'},'& .choiceWidgetAnnotation select':{background:'rgba(0, 54, 255, 0.13)',border:'1px solid transparent',boxSizing:'border-box',fontSize:'9px',height:'100%',margin:0,padding:0,verticalAlign:'top',width:'100%'},'& .checkboxWidgetAnnotation input':{height:'100%',margin:0,verticalAlign:'top',width:'100%'}}},children:[/*#__PURE__*/_jsx(\"canvas\",{ref:canvasRef,style:{display:'block',backgroundColor:'white'}}),/*#__PURE__*/_jsx(\"div\",{ref:textLayerRef}),/*#__PURE__*/_jsx(\"div\",{ref:annotationLayerRef})]})]});};","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}